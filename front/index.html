<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta charset="UTF-8" />
    <title>视频播放</title>
    <link rel="stylesheet" href="/video_watch/src/layui/css/layui.css">
    <!-- <link rel="stylesheet" href="/video_watch/src/layui/css/layui.mobile.css" media="screen and (max-width:768px)"> -->
    <script src="/video_watch/src/hls.js"></script>
    <script src="/video_watch/src/layui/layui.js"></script>
    <script src="/video_watch/src/common.js"></script>
</head>

<body class="layui-layout-body">
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none;"
        id="overlay">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <div class="layui-anim layui-anim-rotate layui-icon layui-icon-loading"
                style="font-size: 50px; color: #fff;animation-iteration-count: infinite"></div>
        </div>
    </div>
    <div class="layui-row" style="margin-top: 30px;">
        <div
            class="layui-col-xs-offset1 layui-col-xs11 layui-col-sm-offset4 layui-col-sm4 layui-col-md-offset4 layui-col-md4">
            <div class="layui-inline">
                <div class="layui-input-inline">
                    <select id="site" lay-filter="site" class="layui-select" lay-verify="required">
                        <option value="">选择站点</option>
                    </select>
                </div>
                <div class="layui-input-inline">
                    <input type="text" id="search" placeholder="请输入搜索内容" class="layui-input" />
                </div>
                <input type="button" id="searchBtn" value="搜索" class="layui-btn" />
            </div>
        </div>
    </div>
    <div class="layui-row" style="margin-top: 10px">
        <div id="searchResult" style="display: none"
            class="layui-cols-xs12 layui-col-sm-offset4 layui-col-sm4 layui-col-md-offset4 layui-col-md4">
        </div>
    </div>
    <div class="layui-row" style="margin-top: 10px">
        <div id="videoDetail" style="display: none"
            class="layui-cols-xs12 layui-col-sm-offset4 layui-col-sm4 layui-col-md-offset4 layui-col-md4">
        </div>
    </div>
    <div class="layui-row" style="margin-top: 10px">
        <video id="player" controls preload="auto" style="width: 98%;margin-left:1%;display:none">
            <source id="player-source" type="application/x-mpegURL" src="" />
        </video>
    </div>
    <script>
        const player = document.getElementById('player');
        const searchResult = document.getElementById('searchResult');
        const videoDetail = document.getElementById('videoDetail');
        const overlay = document.getElementById('overlay');
        const search = () => {
            // 发起视频搜索
            const site = document.getElementById('site').value;
            const search = document.getElementById('search').value;
            if (!site) {
                alert('请选择站点');
                return;
            }
            if (!search) {
                alert('请输入搜索内容');
                return;
            }
            overlay.style.display = 'block';
            searchVideo(site, search).then((res) => {
                // 渲染搜索结果
                renderSearchResult(res);
            }).finally(() => {
                overlay.style.display = 'none';
            });
        }
        const renderVideoDetail = (res) => {
            // 隐藏搜索结果
            searchResult.style.display = 'none';
            // 绘制视频剧集信息
            videoDetail.innerHTML = '';
            res.forEach((element) => {
                let btnDom = document.createElement('button');
                btnDom.innerText = element.title;
                btnDom.style.marginTop = '3px';
                btnDom.style.marginLeft = '10px';
                btnDom.className = 'layui-btn layui-btn-xs layui-btn-normal videoBtn';
                btnDom.onclick = (event) => {
                    // 设置播放剧集
                    localStorage.setItem("title2", element.title);
                    playSelf(element.player_media);
                    window.location.title = localStorage.getItem("title") + " - " + element.title;
                    // 设置当前按钮为选中状态
                    event.target.className = 'layui-btn layui-btn-xs layui-btn-warm videoBtn';
                    // 设置其他按钮为非选中状态
                    let btns = document.getElementsByClassName('videoBtn');
                    for (let i = 0; i < btns.length; i++) {
                        if (btns[i] != event.target) {
                            btns[i].className = 'layui-btn layui-btn-xs layui-btn-normal videoBtn';
                        }
                    }
                }
                videoDetail.appendChild(btnDom);
            })
            title2 = localStorage.getItem("title2");
            let btns = document.getElementsByClassName('videoBtn');
            if (title2) {
                // 存在播放过的视频，点击播放
                for (let i = 0; i < btns.length; i++) {
                    if (btns[i].innerText == title2) {
                        btns[i].click();
                        break;
                    }
                }
                let progress = localStorage.getItem("progress");
                if (progress) {
                    player.currentTime = progress;
                }
            } else {
                // 播放第一个视频
                btns[0]?.click();
            }
            // 显示视频播放
            player.style.display = 'block';
            // 显示视频剧集信息
            videoDetail.style.display = 'block';
        }
        const liOnClick = (title, url) => {
            // 设置信息到localStorage
            localStorage.setItem('title', title);
            localStorage.setItem('page_url', url);
            // 获取视频详情
            const site = document.getElementById('site').value;
            overlay.style.display = 'block';
            getVideoDetail(site, url).then((res) => {
                // 信息存入localStorage
                localStorage.setItem('videoDetail', JSON.stringify(res));
                // 渲染视频信息
                renderVideoDetail(res);
            }).finally(() => {
                overlay.style.display = 'none';
            })
        }
        const renderSearchResult = (res) => {
            // 隐藏视频播放
            player.style.display = 'none';
            videoDetail.style.display = 'none';
            // 清空搜索结果
            searchResult.innerHTML = '';
            // 清空历史播放记录
            localStorage.removeItem('title');
            localStorage.removeItem('title2');
            localStorage.removeItem('page_url');
            localStorage.removeItem('videoDetail');
            // 渲染搜索结果
            let ulDom = document.createElement('ul');
            res.forEach((element, index) => {
                let liDom = document.createElement('li');
                liDom.onclick = () => {
                    liOnClick(element.title, element.page_url);
                };
                let divDom = document.createElement('div');
                liDom.className = 'layui-row';
                liDom.style.cursor = 'pointer';
                divDom.className = 'layui-col-xs3 layui-col-sm3 layui-col-md3';
                let imgDom = document.createElement('img');
                imgDom.src = element.cover;
                imgDom.style.width = '100%';
                imgDom.style.height = '100%';
                divDom.appendChild(imgDom);
                liDom.appendChild(divDom);
                divDom = document.createElement('div');
                divDom.className = 'layui-col-xs-offset1 layui-col-xs8 layui-col-sm-offset1 layui-col-sm8 layui-col-md-offset1 layui-col-md8';
                let hDom = document.createElement('h2');
                hDom.innerHTML = element.title;
                divDom.appendChild(hDom);
                let pDom = document.createElement('p');
                pDom.innerHTML = `主演：${element.actor}`;
                divDom.appendChild(pDom);
                liDom.appendChild(divDom);
                pDom = document.createElement('p');
                pDom.innerHTML = `类型：${element.type}`;
                divDom.appendChild(pDom);
                liDom.appendChild(divDom);
                pDom = document.createElement('p');
                pDom.innerHTML = `导演：${element.director}`;
                divDom.appendChild(pDom);
                liDom.appendChild(divDom);
                pDom = document.createElement('p');
                pDom.innerHTML = `简介：${element.desc}`;
                divDom.appendChild(pDom);
                liDom.appendChild(divDom);
                ulDom.appendChild(liDom);
                if (index != res.length - 1) {
                    let hrDom = document.createElement('hr');
                    ulDom.appendChild(hrDom);
                }
            });
            searchResult.appendChild(ulDom);
            searchResult.style.display = 'block';
        }
        window.onload = async () => {
            // 设置站点信息
            initSiteList();
            // 站点选择事件
            document.getElementById('site').onchange = (event) => {
                // 设置选项到localStorage
                localStorage.setItem('site', event.target.value);
            }
            // 搜索事件
            document.getElementById('searchBtn').onclick = search
            document.getElementById('search').addEventListener('keypress', (event) => {
                if (event.keyCode == 13) {
                    search();
                }
            })
            // 如果有搜索结果，显示上次播放内容
            searchResultData = localStorage.getItem('videoDetail');
            if (searchResultData) {
                // 渲染视频信息
                renderVideoDetail(JSON.parse(searchResultData));
            }
            let content = localStorage.getItem('title')
            const searchInput = document.getElementById('search');
            searchInput.value = content;
        }
        const getInnerText = (node) => {
            return node.innerText ? node.innerText : node.innerHTML.trim();
        }
        let progressIntId = 0;
        player.addEventListener('play', function () {
            // 视频播放 注册记录播放进度信息
            if (!progressIntId) {
                progressIntId = setInterval(() => {
                    localStorage.setItem('progress', player.currentTime);
                }, 1500);
            }
        });
        player.addEventListener('pause', function () {
            clearInterval(progressIntId);
            progressIntId = 0;
        })

        function playSelf(playerUrl) {
            player.style.display = 'block';

            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(playerUrl);
                hls.attachMedia(player);
                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    try {
                        player.play();
                    } catch (e) {

                    }
                });
            }
            // 对于原生支持HLS的浏览器（如Safari）
            else if (player.canPlayType('application/vnd.apple.mpegurl')) {
                player.src = playerUrl;
                player.addEventListener('loadedmetadata', function () {
                    try {
                        player.play();
                    } catch (e) {

                    }
                });
            }
            setTimeout(() => {
                // 滚动页面到底部
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: 'smooth'
                });
            }, 200)
        }
    </script>
</body>

</html>